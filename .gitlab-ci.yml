variables:
  DOCKER_IMAGE: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/docker-images/$CI_PROJECT_NAME
  CLOUD_RUN_SERVICE: $CI_PROJECT_NAME
  GCP_REGION: us-central1

  # Cloud Run Configuration - Override these in your repo's CI/CD variables
  CLOUD_RUN_MEMORY: "512Mi"           # Options: 128Mi, 256Mi, 512Mi, 1Gi, 2Gi, 4Gi, 8Gi
  CLOUD_RUN_CPU: "1"                  # Options: 1, 2, 4, 8
  CLOUD_RUN_TIMEOUT: "300"            # Seconds (max 3600 for services, 86400 for jobs)
  CLOUD_RUN_MAX_INSTANCES: "3"        # Max concurrent instances
  CLOUD_RUN_MIN_INSTANCES: "0"        # Min instances (0 = scale to zero)
  CLOUD_RUN_CONCURRENCY: "80"         # Requests per instance

  # Deploy mode: "job" (default, up to 24h) or "service" (for HTTP APIs, max 1h)
  DEPLOY_MODE: "job"

stages:
  - build
  - deploy

# Build and push Docker image using Kaniko
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  script:
    - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/Dockerfile" --destination "${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}" --destination "${DOCKER_IMAGE}:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Deploy to Cloud Run Service (default - for HTTP APIs, max 1h timeout)
deploy-service:
  stage: deploy
  image: google/cloud-sdk:slim
  before_script:
    - gcloud config set project $GCP_PROJECT_ID
  script:
    - export PLATFORM_ID=${CI_PROJECT_NAME#scraper-}
    - gcloud run deploy $CLOUD_RUN_SERVICE --image=$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA --region=$GCP_REGION --platform=managed --allow-unauthenticated --memory=$CLOUD_RUN_MEMORY --cpu=$CLOUD_RUN_CPU --timeout=${CLOUD_RUN_TIMEOUT}s --max-instances=$CLOUD_RUN_MAX_INSTANCES --min-instances=$CLOUD_RUN_MIN_INSTANCES --concurrency=$CLOUD_RUN_CONCURRENCY --set-env-vars="ENVIRONMENT=production,SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL,PLATFORM_ID=$PLATFORM_ID,GCS_FOLDER=$PLATFORM_ID"
    - gcloud run services describe $CLOUD_RUN_SERVICE --region=$GCP_REGION --format="value(status.url)"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $DEPLOY_MODE == "service"
    - if: $CI_COMMIT_TAG && $DEPLOY_MODE == "service"
  environment:
    name: production
    url: https://$CLOUD_RUN_SERVICE-$GCP_PROJECT_ID.$GCP_REGION.run.app

# Deploy to Cloud Run Job (for long-running tasks, max 24h timeout)
deploy-job:
  stage: deploy
  image: google/cloud-sdk:slim
  before_script:
    - gcloud config set project $GCP_PROJECT_ID
  script:
    - export PLATFORM_ID=${CI_PROJECT_NAME#scraper-}
    - gcloud run jobs deploy $CLOUD_RUN_SERVICE --image=$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA --region=$GCP_REGION --memory=$CLOUD_RUN_MEMORY --cpu=$CLOUD_RUN_CPU --task-timeout=${CLOUD_RUN_TIMEOUT}s --max-retries=1 --parallelism=1 --set-env-vars="ENVIRONMENT=production,SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL,PLATFORM_ID=$PLATFORM_ID,GCS_FOLDER=$PLATFORM_ID"
    - echo "Job deployed - Run with gcloud run jobs execute $CLOUD_RUN_SERVICE --region=$GCP_REGION"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $DEPLOY_MODE == "job"
    - if: $CI_COMMIT_TAG && $DEPLOY_MODE == "job"
